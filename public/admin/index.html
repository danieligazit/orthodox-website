<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link href="/orthodox-website/admin/config.yml" type="text/yaml" rel="cms-config-url" />
</head>
<body>
  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('access_token');
      if (token) {
        console.log('[Decap Popup] Token detected. Saving and closing.');
        localStorage.setItem('netlify-cms-auth-token', token);
        document.body.innerHTML = '<div style="display:flex;height:100vh;align-items:center;justify-content:center;font-family:sans-serif;"><h1>Login successful. Closing...</h1></div>';
        setTimeout(() => window.close(), 500);
        throw new Error('Stop execution'); // Stop CMS form loading in popup
      }
    })();
  </script>

  <script>
    window.CMS_MANUAL_INIT = true;
    const PROXY_URL = 'https://decap-oauth-proxy.danieligazit.workers.dev';

    // Helper: Validates token
    async function fetchUser(token) {
      const response = await fetch(`${PROXY_URL}/user`, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!response.ok) throw new Error('Failed to fetch user');
      const userData = await response.json();
      return {
        token: token,
        name: userData.name || userData.login,
        login: userData.login,
        avatar_url: userData.avatar_url,
        email: userData.email
      };
    }

    // This variable will hold the real CMS object
    let _cms;

    // We define window.CMS *before* the script loads. 
    // When Decap tries to set window.CMS, our 'set' function runs.
    Object.defineProperty(window, 'CMS', {
      get: function() { return _cms; },
      set: function(cmsInstance) {
        _cms = cmsInstance;
        console.log('[Decap Trap] CMS object captured!');

        if (_cms && _cms.registerBackend) {
          const originalRegister = _cms.registerBackend;
          
          // We override registerBackend immediately
          _cms.registerBackend = function(name, BackendClass, options) {
            
            // If the CMS is trying to register 'github', we intercept it!
            if (name === 'github') {
              console.log('[Decap Trap] Intercepted GitHub registration. Class captured.');
              
              // Now we have the REAL 'BackendClass' constructor (before it got lost)
              class CustomGitHubBackend extends BackendClass {
                
                authenticate(credentials) {
                  const token = localStorage.getItem('netlify-cms-auth-token');
                  if (token) return this.restoreUser();

                  // Polling logic for Popup
                  const authPromise = super.authenticate(credentials);
                  return new Promise((resolve, reject) => {
                    const poll = setInterval(() => {
                      const localToken = localStorage.getItem('netlify-cms-auth-token');
                      if (localToken) {
                        clearInterval(poll);
                        fetchUser(localToken).then(resolve).catch(reject);
                      }
                    }, 500);
                    // Also listen to standard flow
                    authPromise.then(resolve).catch(err => console.log('Standard auth waiting...', err));
                    setTimeout(() => clearInterval(poll), 120000); // 2 min timeout
                  });
                }

                async restoreUser() {
                  const token = localStorage.getItem('netlify-cms-auth-token');
                  if (!token) return Promise.reject();
                  console.log('[Decap Trap] restoring user...');
                  try {
                    return await fetchUser(token);
                  } catch (e) {
                    localStorage.removeItem('netlify-cms-auth-token');
                    return Promise.reject();
                  }
                }
              }

              // Register OUR modified class
              originalRegister.call(this, name, CustomGitHubBackend, options);
              console.log('[Decap Trap] Custom GitHub Backend registered successfully.');
            } else {
              // Pass everything else through normally
              originalRegister.call(this, name, BackendClass, options);
            }
          };
        }
      }
    });
  </script>

  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>

  <script>
    // Wait for the trap to spring and the CMS to load
    const interval = setInterval(() => {
      if (window.CMS) {
        clearInterval(interval);
        console.log('[Decap Debug] Starting CMS...');
        window.CMS.init();
      }
    }, 100);
  </script>
</body>
</html>