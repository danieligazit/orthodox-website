<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link href="/orthodox-website/admin/config.yml" type="text/yaml" rel="cms-config-url" />
</head>
<body>
  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('access_token');
      if (token) {
        localStorage.setItem('netlify-cms-auth-token', token);
        document.body.innerHTML = `<div style="display:flex;height:100vh;align-items:center;justify-content:center;font-family:sans-serif;flex-direction:column;text-align:center;"><h1>Login successful!</h1><p>Closing...</p></div>`;
        
        try {
          if (window.opener) {
            window.opener.postMessage("cms-auth-success", "*");
          }
        } catch(e) { /* ignore cross-origin issues */ }

        setTimeout(() => window.close(), 1000);
        throw new Error('[Decap Popup] Token saved, stopping execution.');
      }
    })();
  </script>

  <script>
    window.CMS_MANUAL_INIT = true;
    const PROXY_URL = 'https://decap-oauth-proxy.danieligazit.workers.dev';

    // Helper: Timeout wrapper for fetch
    async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 10000 } = options; // 10 seconds
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);

        try {
            const response = await fetch(resource, {
                ...options,
                signal: controller.signal  
            });
            clearTimeout(id);
            return response;
        } catch (error) {
            clearTimeout(id);
            if (error.name === 'AbortError') {
                throw new Error('Network request timed out after 10 seconds.');
            }
            throw error;
        }
    }

    // Helper: Validates token
    async function fetchUser(token) {
      console.log('[Decap Trap - NETWORK] Starting fetch to proxy...');
      
      const response = await fetchWithTimeout(`${PROXY_URL}/user`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      console.log(`[Decap Trap - NETWORK] Fetch completed with status: ${response.status}`);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Proxy validation failed: ${response.status} - ${errorText.substring(0, 100)}`);
      }
      
      const userData = await response.json();
      console.log(`[Decap Trap - NETWORK] User data retrieved for: ${userData.login}`);
      return {
        token: token,
        name: userData.name || userData.login,
        login: userData.login,
        avatar_url: userData.avatar_url,
        email: userData.email
      };
    }

    let _cms;
    Object.defineProperty(window, 'CMS', {
      get: function() { return _cms; },
      set: function(cmsInstance) {
        _cms = cmsInstance;
        
        if (_cms && _cms.registerBackend) {
          const originalRegister = _cms.registerBackend;
          
          _cms.registerBackend = function(name, BackendClass, options) {
            if (name === 'github') {
              
              class CustomGitHubBackend extends BackendClass {
                
                authenticate(credentials) {
                  const existingToken = localStorage.getItem('netlify-cms-auth-token');
                  if (existingToken) return this.restoreUser();

                  super.authenticate(credentials).catch(err => {
                    // Standard flow rejected, we proceed with our custom listener
                  });

                  return new Promise((resolve, reject) => {
                    console.log('[Decap Trap - AUTH] Waiting for token signal...');
                    
                    const poll = setInterval(() => {
                      const token = localStorage.getItem('netlify-cms-auth-token');
                      if (token) {
                        console.log('[Decap Trap - AUTH] Token signal received via Polling.');
                        finish(token);
                      }
                    }, 500);

                    const onStorage = (e) => {
                      if (e.key === 'netlify-cms-auth-token' && e.newValue) {
                         console.log('[Decap Trap - AUTH] Token signal received via Storage Event.');
                         finish(e.newValue);
                      }
                    };
                    
                    const onMessage = (e) => {
                      if (e.data === "cms-auth-success") {
                        console.log('[Decap Trap - AUTH] Token signal received via PostMessage.');
                        const token = localStorage.getItem('netlify-cms-auth-token');
                        if (token) finish(token);
                      }
                    };

                    window.addEventListener('storage', onStorage);
                    window.addEventListener('message', onMessage);

                    // Cleanup and Log In
                    function finish(token) {
                      console.log('[Decap Trap - AUTH] Finish routine started.');
                      clearInterval(poll);
                      window.removeEventListener('storage', onStorage);
                      window.removeEventListener('message', onMessage);
                      
                      fetchUser(token)
                        .then(user => {
                          console.log('[Decap Trap - AUTH] Login successful, resolving Promise.');
                          resolve(user);
                        })
                        .catch(err => {
                          console.error('[Decap Trap - AUTH] Validation FAILED:', err);
                          reject(err);
                        });
                    }
                  });
                }

                async restoreUser() {
                  const token = localStorage.getItem('netlify-cms-auth-token');
                  if (!token) return Promise.reject();
                  try {
                    return await fetchUser(token);
                  } catch (e) {
                    console.error('[Decap Trap - AUTH] Restore failed:', e);
                    localStorage.removeItem('netlify-cms-auth-token');
                    return Promise.reject();
                  }
                }
              }

              originalRegister.call(this, name, CustomGitHubBackend, options);
            } else {
              originalRegister.call(this, name, BackendClass, options);
            }
          };
        }
      }
    });
  </script>

  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>

  <script>
    const interval = setInterval(() => {
      if (window.CMS) {
        clearInterval(interval);
        console.log('[Decap Debug] Starting CMS...');
        window.CMS.init();
      }
    }, 100);
  </script>
</body>
</html>