<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <script>
    if (window.location.search.includes('access_token')) {
      const token = new URLSearchParams(window.location.search).get('access_token');
      
      // 1. Send to Opener
      if (window.opener) {
        window.opener.postMessage(token, "*"); 
      }
      
      // 2. Save for backup polling
      localStorage.setItem('cms-token', token);
      
      document.body.innerHTML = '<div style="display:flex;height:100vh;align-items:center;justify-content:center;font-family:sans-serif;"><h1>Login success. Closing...</h1></div>';
      setTimeout(() => window.close(), 500);
      throw new Error('Stop execution');
    }
  </script>

  <script>
    window.CMS_MANUAL_INIT = true;
    const PROXY_URL = 'https://decap-oauth-proxy.danieligazit.workers.dev';

    // We define window.CMS *before* Decap loads.
    // This allows us to catch the registerBackend function.
    let _cms;
    Object.defineProperty(window, 'CMS', {
      get: function() { return _cms; },
      set: function(cmsInstance) {
        _cms = cmsInstance;
        
        if (_cms && _cms.registerBackend) {
          const originalRegister = _cms.registerBackend;
          
          // We override the register function
          _cms.registerBackend = function(name, BackendClass, options) {
            
            // 1. Allow the standard registration to proceed
            originalRegister.call(this, name, BackendClass, options);

            // 2. Detect when the 'github' backend is being registered
            if (name === 'github') {
              console.log('[Decap Setup] Intercepted GitHub Class! Creating github-proxy...');

              // NOW we have the real Class Constructor (BackendClass)
              // We can safely extend it to inherit the UI (authComponent)
              class ProxyBackend extends BackendClass {
                constructor(config) {
                  super(config);
                }

                authenticate(credentials) {
                  const token = localStorage.getItem('cms-token');
                  if (token) return this.validate(token);

                  return new Promise((resolve, reject) => {
                    // A. Open Popup
                    const width = 600, height = 600;
                    const left = (window.innerWidth / 2) - (width / 2);
                    const top = (window.innerHeight / 2) - (height / 2);
                    const authUrl = `${PROXY_URL}/auth?provider=github&site_id=orthodox-website`;
                    
                    window.open(authUrl, 'auth', `width=${width},height=${height},top=${top},left=${left}`);

                    // B. Listen for Token (PostMessage)
                    const msgListener = (event) => {
                      if (typeof event.data === 'string' && event.data.startsWith('gho_')) {
                        cleanup();
                        localStorage.setItem('cms-token', event.data);
                        this.validate(event.data).then(resolve).catch(reject);
                      }
                    };

                    // C. Poll LocalStorage (Backup)
                    const poll = setInterval(() => {
                      const t = localStorage.getItem('cms-token');
                      if (t) {
                        cleanup();
                        this.validate(t).then(resolve).catch(reject);
                      }
                    }, 500);

                    const cleanup = () => {
                      window.removeEventListener('message', msgListener);
                      clearInterval(poll);
                    };

                    window.addEventListener('message', msgListener);
                  });
                }

                async validate(token) {
                  try {
                    const response = await fetch(`${PROXY_URL}/user`, {
                      headers: { 'Authorization': `token ${token}` }
                    });
                    if (!response.ok) throw new Error('Invalid token');
                    
                    const user = await response.json();
                    return {
                      token: token,
                      name: user.name || user.login,
                      login: user.login,
                      avatar_url: user.avatar_url
                    };
                  } catch (e) {
                    console.error('Validation failed', e);
                    localStorage.removeItem('cms-token');
                    throw e;
                  }
                }

                logout() {
                  localStorage.removeItem('cms-token');
                  return super.logout();
                }
              }

              // 3. Register OUR backend as 'github-proxy'
              console.log('[Decap Setup] Registering github-proxy subclass...');
              _cms.registerBackend('github-proxy', ProxyBackend);
              
              // 4. Start the CMS
              setTimeout(() => {
                console.log('[Decap Setup] Starting CMS...');
                _cms.init();
              }, 100);
            }
          };
        }
      }
    });
  </script>

  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>
</body>
</html>