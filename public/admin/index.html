<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Point Decap CMS to the config file -->
  <link href="/orthodox-website/admin/config.yml" type="text/yaml" rel="cms-config-url" />
</head>
<body>
  <!-- Handle OAuth callback token -->
  <script>
    // Read token from URL and make it available to Decap CMS
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get('access_token');
    
    if (accessToken) {
      // Store token for Decap CMS
      localStorage.setItem('netlify-cms-auth-token', accessToken);
      
      // Clean up URL - remove query params but keep hash if present
      const cleanUrl = window.location.pathname + (window.location.hash || '');
      window.history.replaceState({}, document.title, cleanUrl);
      
      // Force page reload to ensure Decap CMS picks up the token
      // Note: reload() stops execution automatically, no return needed
      window.location.reload();
    }
  </script>
  
  <script>
    // Intercept ALL network requests BEFORE Decap CMS loads to ensure token is always sent
    // This must run before Decap CMS initializes
    (function() {
      // Store original fetch immediately
      const originalFetch = window.fetch;
      
      // Override fetch to add Authorization header for proxy requests
      window.fetch = function(url, options = {}) {
        // Always check for token (in case it was just stored)
        const token = localStorage.getItem('netlify-cms-auth-token');
        
        // If this is a request to our OAuth proxy, add the token
        if (token && typeof url === 'string' && url.includes('decap-oauth-proxy')) {
          options = options || {};
          
          // Handle both Headers object and plain object
          if (options.headers instanceof Headers) {
            if (!options.headers.has('Authorization')) {
              options.headers.set('Authorization', `token ${token}`);
            }
          } else {
            options.headers = options.headers || {};
            // Check both cases
            if (!options.headers['Authorization'] && !options.headers['authorization']) {
              options.headers['Authorization'] = `token ${token}`;
            }
          }
        }
        
        return originalFetch.call(this, url, options);
      };
      
      // Also intercept XMLHttpRequest (some libraries use this instead of fetch)
      const originalXHROpen = XMLHttpRequest.prototype.open;
      const originalXHRSend = XMLHttpRequest.prototype.send;
      const originalXHRSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
      
      XMLHttpRequest.prototype.open = function(method, url, ...args) {
        this._url = url;
        return originalXHROpen.apply(this, [method, url, ...args]);
      };
      
      XMLHttpRequest.prototype.setRequestHeader = function(name, value) {
        // Store headers to check later
        if (!this._headers) {
          this._headers = {};
        }
        this._headers[name.toLowerCase()] = value;
        return originalXHRSetRequestHeader.apply(this, arguments);
      };
      
      XMLHttpRequest.prototype.send = function(...args) {
        const token = localStorage.getItem('netlify-cms-auth-token');
        if (token && this._url && this._url.includes('decap-oauth-proxy')) {
          // Check if Authorization header is already set
          if (!this._headers || !this._headers['authorization']) {
            originalXHRSetRequestHeader.call(this, 'Authorization', `token ${token}`);
          }
        }
        return originalXHRSend.apply(this, args);
      };
    })();
  </script>
  
  <!-- Include Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>
  
  <script>
    // Configure Decap CMS authentication IMMEDIATELY
    // We need to hook into Decap CMS as soon as it's available
    (function() {
      const token = localStorage.getItem('netlify-cms-auth-token');
      
      if (!token) {
        // No token - user needs to login
        return;
      }
      
      // Hook into Decap CMS initialization immediately
      // Check both before and after DOMContentLoaded
      function setupAuth() {
        const CMS = window.CMS || window.netlifyCMS;
        if (!CMS) return false;
        
        try {
          // Get the GitHub backend
          const backend = CMS.getBackend('github');
          
          if (!backend) {
            return false; // Backend not ready yet
          }
          
          // Check if we've already set up the override
          if (backend._authOverrideSet) {
            return true;
          }
          
          // Mark that we've set up the override
          backend._authOverrideSet = true;
          
          // Store original methods
          const originalRestoreUser = backend.restoreUser;
          const originalAuthenticate = backend.authenticate;
          
          // Override restoreUser to restore from localStorage and verify token
          backend.restoreUser = function() {
            const storedToken = localStorage.getItem('netlify-cms-auth-token');
            if (!storedToken) {
              return originalRestoreUser ? originalRestoreUser.call(this) : Promise.reject('No token');
            }
            
            // Verify token by making a request to the backend
            const proxyUrl = 'https://decap-oauth-proxy.danieligazit.workers.dev';
            return fetch(`${proxyUrl}/user`, {
              headers: {
                'Authorization': `token ${storedToken}`
              }
            })
            .then(response => {
              if (response.ok) {
                return response.json().then(userData => {
                  // Return user object that Decap CMS expects
                  return {
                    token: storedToken,
                    name: userData.login || userData.name,
                    login: userData.login,
                    avatar_url: userData.avatar_url,
                    email: userData.email
                  };
                });
              } else {
                // Token invalid, clear it
                localStorage.removeItem('netlify-cms-auth-token');
                throw new Error('Token invalid');
              }
            })
            .catch(error => {
              console.error('Token verification failed:', error);
              // Still try original restoreUser as fallback
              return originalRestoreUser ? originalRestoreUser.call(this) : Promise.reject(error);
            });
          };
          
          // Override authenticate to use stored token
          backend.authenticate = function() {
            const storedToken = localStorage.getItem('netlify-cms-auth-token');
            if (storedToken) {
              // Use restoreUser to verify and get user info
              return backend.restoreUser();
            }
            return originalAuthenticate ? originalAuthenticate.call(this) : Promise.reject('No token');
          };
          
          // Try to restore user immediately
          backend.restoreUser()
            .then(function(user) {
              console.log('User authenticated:', user);
            })
            .catch(function(error) {
              console.log('Authentication check failed:', error);
            });
          
          return true;
        } catch (error) {
          console.error('Error configuring Decap CMS authentication:', error);
          return false;
        }
      }
      
      // Try immediately (in case CMS loads synchronously)
      if (!setupAuth()) {
        // If not ready, check periodically
        let checkCount = 0;
        const maxChecks = 100; // 5 seconds max
        
        const checkInterval = setInterval(function() {
          checkCount++;
          if (setupAuth() || checkCount >= maxChecks) {
            clearInterval(checkInterval);
          }
        }, 50);
      }
      
      // Also try on DOMContentLoaded
      window.addEventListener('DOMContentLoaded', function() {
        setupAuth();
      });
    })();
  </script>
</body>
</html>