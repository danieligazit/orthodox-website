<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  
  <link href="/orthodox-website/admin/config.yml" type="text/yaml" rel="cms-config-url" />
</head>
<body>
  <script>
    console.log('[Decap Debug] Setting CMS_MANUAL_INIT = true');
    window.CMS_MANUAL_INIT = true;
  </script>
  
  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>

  <script>
    const PROXY_URL = 'https://decap-oauth-proxy.danieligazit.workers.dev';

    // Helper: Get token from URL (first load) or LocalStorage (subsequent loads)
    function getAuthToken() {
      console.log('[Decap Debug] getAuthToken() called');
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('access_token');
      
      if (tokenFromUrl) {
        console.log('[Decap Debug] Token found in URL. Saving to LocalStorage...');
        localStorage.setItem('netlify-cms-auth-token', tokenFromUrl);
        
        // Clean the URL
        window.history.replaceState({}, document.title, window.location.pathname);
        return tokenFromUrl;
      }

      const localToken = localStorage.getItem('netlify-cms-auth-token');
      if (localToken) {
        console.log('[Decap Debug] Token found in LocalStorage');
      } else {
        console.log('[Decap Debug] No token found in URL or LocalStorage');
      }
      return localToken;
    }

    // Helper: Validate token with your Cloudflare Worker
    async function fetchUser(token) {
      console.log(`[Decap Debug] fetchUser() calling proxy: ${PROXY_URL}/user`);
      
      try {
        const response = await fetch(`${PROXY_URL}/user`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        console.log('[Decap Debug] Proxy response status:', response.status);

        if (!response.ok) {
          console.error('[Decap Debug] Proxy returned error:', response.statusText);
          throw new Error('Failed to fetch user');
        }
        
        const userData = await response.json();
        console.log('[Decap Debug] User data received:', userData.login);
        
        return {
          token: token, 
          name: userData.name || userData.login,
          login: userData.login,
          avatar_url: userData.avatar_url,
          email: userData.email
        };
      } catch (e) {
        console.error('[Decap Debug] fetchUser failed:', e);
        throw e;
      }
    }

    // Main Setup Function
    function registerCustomBackend() {
      const CMS = window.CMS;
      console.log('[Decap Debug] registerCustomBackend() started');
      
      const originalRegisterBackend = CMS.registerBackend;

      // We intercept the registration of the 'github' backend
      CMS.registerBackend = (name, BackendClass, options) => {
        console.log(`[Decap Debug] CMS.registerBackend called for: ${name}`);

        if (name === 'github') {
          console.log('[Decap Debug] Intercepting GitHub backend registration');

          class CustomGitHubBackend extends BackendClass {
            
            // Override 1: Login Button Click
            authenticate(credentials) {
              console.log('[Decap Debug] Backend.authenticate() triggered');
              const token = getAuthToken();
              
              if (token) {
                console.log('[Decap Debug] Token exists during authenticate(), attempting restoreUser() instead of popup');
                return this.restoreUser();
              }
              
              console.log('[Decap Debug] No token, proceeding with standard popup flow');
              return super.authenticate(credentials);
            }

            // Override 2: Page Load
            async restoreUser() {
              console.log('[Decap Debug] Backend.restoreUser() triggered');
              const token = getAuthToken();
              
              if (!token) {
                console.log('[Decap Debug] No token available for restoreUser');
                return Promise.reject();
              }

              try {
                const user = await fetchUser(token);
                console.log('[Decap Debug] restoreUser success. Logged in as:', user.login);
                return user;
              } catch (error) {
                console.warn('[Decap Debug] restoreUser failed (invalid token). Clearing LocalStorage.');
                localStorage.removeItem('netlify-cms-auth-token');
                return Promise.reject();
              }
            }
          }

          // Register OUR class instead of the default one
          originalRegisterBackend.call(CMS, name, CustomGitHubBackend, options);
        } else {
          originalRegisterBackend.call(CMS, name, BackendClass, options);
        }
      };
    }

    // 4. BOOTSTRAP
    console.log('[Decap Debug] Waiting for window.CMS...');
    const interval = setInterval(() => {
      if (window.CMS) {
        console.log('[Decap Debug] window.CMS detected!');
        clearInterval(interval);
        
        registerCustomBackend();
        
        console.log('[Decap Debug] Calling CMS.init()...');
        window.CMS.init();
      }
    }, 50);

  </script>
</body>
</html>