<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <script>
    if (window.location.search.includes('access_token')) {
      const token = new URLSearchParams(window.location.search).get('access_token');
      if (window.opener) {
        window.opener.postMessage(token, "*"); 
      }
      localStorage.setItem('cms-token', token);
      document.body.innerHTML = '<h1>Login success. Closing...</h1>';
      setTimeout(() => window.close(), 500);
      throw new Error('Stop execution');
    }
  </script>

  <script>window.CMS_MANUAL_INIT = true;</script>
  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>

  <script>
    const PROXY_URL = 'https://decap-oauth-proxy.danieligazit.workers.dev';

    // Poll for CMS availability
    const checkCMS = setInterval(() => {
      if (window.CMS && window.CMS.getBackend && window.CMS.getBackend('github')) {
        clearInterval(checkCMS);
        initializeCustomBackend();
      }
    }, 100);

    function initializeCustomBackend() {
      console.log('[Decap Debug] CMS Ready. Creating Custom Proxy Backend...');
      
      const CMS = window.CMS;
      const OriginalGitHub = CMS.getBackend('github');

      // 1. Define a Custom "Login with GitHub" Button Component
      // We use the global 'React' object that Decap CMS loads.
      class LoginButton extends window.React.Component {
        render() {
          return window.React.createElement(
            'button',
            {
              style: {
                backgroundColor: 'rgb(23, 27, 33)',
                color: '#ffffff',
                padding: '10px 20px',
                fontSize: '16px',
                fontWeight: 'bold',
                border: 'none',
                borderRadius: '5px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '10px',
                margin: '20px auto'
              },
              onClick: this.props.onLogin // Decap passes this prop automatically
            },
            // Button Text
            'Login with GitHub (Proxy)'
          );
        }
      }

      // 2. Create the Proxy Class
      class ProxyBackend {
        constructor(config) {
          // Initialize the real GitHub backend internally
          // We handle the "Not a constructor" case just to be safe
          try {
            this.gh = new OriginalGitHub(config);
          } catch (e) {
            this.gh = OriginalGitHub;
          }
        }

        // Custom Auth Logic
        authenticate(credentials) {
          const token = localStorage.getItem('cms-token');
          if (token) return this.validate(token);

          return new Promise((resolve, reject) => {
            const width = 600, height = 600;
            const left = (window.innerWidth / 2) - (width / 2);
            const top = (window.innerHeight / 2) - (height / 2);
            const authUrl = `${PROXY_URL}/auth?provider=github&site_id=orthodox-website`;
            
            window.open(authUrl, 'auth', `width=${width},height=${height},top=${top},left=${left}`);

            const listener = (event) => {
              if (typeof event.data === 'string' && event.data.startsWith('gho_')) {
                window.removeEventListener('message', listener);
                localStorage.setItem('cms-token', event.data);
                this.validate(event.data).then(resolve).catch(reject);
              }
            };
            window.addEventListener('message', listener);
          });
        }

        async validate(token) {
          try {
            const response = await fetch(`${PROXY_URL}/user`, {
              headers: { 'Authorization': `token ${token}` }
            });
            if (!response.ok) throw new Error('Invalid token');
            
            const user = await response.json();
            
            // Pass token to internal backend so Git works
            this.gh.token = token; 
            
            return {
              token: token,
              name: user.name || user.login,
              login: user.login,
              avatar_url: user.avatar_url
            };
          } catch (e) {
            localStorage.removeItem('cms-token');
            throw e;
          }
        }
        
        // Forward logout
        logout() {
          localStorage.removeItem('cms-token');
          if (this.gh.logout) return this.gh.logout();
        }

        // Forward all other methods (getEntry, persistEntry, etc) to the real backend
        getToken() { return this.gh.getToken(); }
        getEntry(collection, slug) { return this.gh.getEntry(collection, slug); }
        getEntries(collection) { return this.gh.getEntries(collection); }
        getMedia(mediaFolder) { return this.gh.getMedia(mediaFolder); }
        persistEntry(entry, options) { return this.gh.persistEntry(entry, options); }
        persistMedia(media, options) { return this.gh.persistMedia(media, options); }
        deleteFile(path, commitMessage, options) { return this.gh.deleteFile(path, commitMessage, options); }
        traverseCursor(cursor, action) { return this.gh.traverseCursor(cursor, action); }
      }

      // 3. Attach our Custom Login Button
      ProxyBackend.authComponent = LoginButton;

      // 4. Register and Start
      console.log('[Decap Debug] Registering "github-proxy"...');
      CMS.registerBackend('github-proxy', ProxyBackend);
      
      console.log('[Decap Debug] Starting CMS...');
      CMS.init();
    }
  </script>
</body>
</html>