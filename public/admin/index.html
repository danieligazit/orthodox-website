<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Point Decap CMS to the config file -->
  <link href="/orthodox-website/admin/config.yml" type="text/yaml" rel="cms-config-url" />
</head>
<body>
  <!-- Handle OAuth callback token -->
  <script>
    // Read token from URL and store it
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get('access_token');
    
    if (accessToken) {
      localStorage.setItem('netlify-cms-auth-token', accessToken);
      // Clean up URL and reload
      window.history.replaceState({}, document.title, window.location.pathname);
      window.location.reload();
      // Stop execution - reload happens above
    }
  </script>
  
  <!-- Intercept network requests to add Authorization header -->
  <script>
    (function() {
      const token = localStorage.getItem('netlify-cms-auth-token');
      if (!token) return;
      
      const proxyUrl = 'https://decap-oauth-proxy.danieligazit.workers.dev';
      
      // Override fetch
      const originalFetch = window.fetch;
      window.fetch = function(url, options = {}) {
        if (typeof url === 'string' && url.includes(proxyUrl)) {
          options = options || {};
          options.headers = options.headers || {};
          if (options.headers instanceof Headers) {
            if (!options.headers.has('Authorization')) {
              options.headers.set('Authorization', `token ${token}`);
            }
          } else {
            if (!options.headers['Authorization'] && !options.headers['authorization']) {
              options.headers['Authorization'] = `token ${token}`;
            }
          }
        }
        return originalFetch.call(this, url, options);
      };
      
      // Override XMLHttpRequest
      const originalXHROpen = XMLHttpRequest.prototype.open;
      const originalXHRSend = XMLHttpRequest.prototype.send;
      const originalXHRSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
      
      XMLHttpRequest.prototype.open = function(method, url, ...args) {
        this._url = url;
        return originalXHROpen.apply(this, [method, url, ...args]);
      };
      
      XMLHttpRequest.prototype.setRequestHeader = function(name, value) {
        if (!this._headers) this._headers = {};
        this._headers[name.toLowerCase()] = value;
        return originalXHRSetRequestHeader.apply(this, arguments);
      };
      
      XMLHttpRequest.prototype.send = function(...args) {
        const token = localStorage.getItem('netlify-cms-auth-token');
        if (token && this._url && this._url.includes(proxyUrl)) {
          if (!this._headers || !this._headers['authorization']) {
            originalXHRSetRequestHeader.call(this, 'Authorization', `token ${token}`);
          }
        }
        return originalXHRSend.apply(this, args);
      };
    })();
  </script>
  
  <!-- Set up Decap CMS authentication -->
  <script>
    (function() {
      const token = localStorage.getItem('netlify-cms-auth-token');
      if (!token) {
        // No token, load CMS normally (will show login)
        loadCMS();
        return;
      }
      
      // Pre-fetch user data
      const proxyUrl = 'https://decap-oauth-proxy.danieligazit.workers.dev';
      fetch(`${proxyUrl}/user`, {
        headers: { 'Authorization': `token ${token}` }
      })
      .then(response => {
        if (response.ok) {
          return response.json().then(userData => {
            // Cache user data
            window._decapCMSUserCache = {
              token: token,
              name: userData.login || userData.name,
              login: userData.login,
              avatar_url: userData.avatar_url,
              email: userData.email
            };
            loadCMS();
          });
        } else {
          localStorage.removeItem('netlify-cms-auth-token');
          loadCMS();
        }
      })
      .catch(err => {
        console.log('Pre-fetch failed:', err);
        loadCMS();
      });
      
      function loadCMS() {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js';
        script.onload = function() {
          setTimeout(setupAuth, 100);
        };
        document.body.appendChild(script);
      }
      
      function setupAuth() {
        const CMS = window.CMS || window.netlifyCMS;
        if (!CMS) {
          setTimeout(setupAuth, 100);
          return;
        }
        
        try {
          const backend = CMS.getBackend('github');
          if (!backend) {
            setTimeout(setupAuth, 100);
            return;
          }
          
          if (backend._authSetup) return;
          backend._authSetup = true;
          
          const token = localStorage.getItem('netlify-cms-auth-token');
          if (!token) return;
          
          // Set cached user if available
          if (window._decapCMSUserCache) {
            backend.currentUser = window._decapCMSUserCache;
            if (backend.user !== undefined) {
              backend.user = window._decapCMSUserCache;
            }
          }
          
          // Override restoreUser
          const originalRestoreUser = backend.restoreUser;
          backend.restoreUser = function() {
            const token = localStorage.getItem('netlify-cms-auth-token');
            if (!token) {
              backend.currentUser = null;
              return originalRestoreUser ? originalRestoreUser.call(this) : Promise.reject('No token');
            }
            
            // Return cached user if available
            if (window._decapCMSUserCache && window._decapCMSUserCache.token === token) {
              backend.currentUser = window._decapCMSUserCache;
              if (backend.user !== undefined) {
                backend.user = window._decapCMSUserCache;
              }
              return Promise.resolve(window._decapCMSUserCache);
            }
            
            // Otherwise fetch user
            const proxyUrl = 'https://decap-oauth-proxy.danieligazit.workers.dev';
            return fetch(`${proxyUrl}/user`, {
              headers: { 'Authorization': `token ${token}` }
            })
            .then(response => {
              if (response.ok) {
                return response.json().then(userData => {
                  const user = {
                    token: token,
                    name: userData.login || userData.name,
                    login: userData.login,
                    avatar_url: userData.avatar_url,
                    email: userData.email
                  };
                  window._decapCMSUserCache = user;
                  backend.currentUser = user;
                  if (backend.user !== undefined) {
                    backend.user = user;
                  }
                  return user;
                });
              } else {
                localStorage.removeItem('netlify-cms-auth-token');
                backend.currentUser = null;
                throw new Error('Token invalid');
              }
            })
            .catch(error => {
              backend.currentUser = null;
              return originalRestoreUser ? originalRestoreUser.call(this) : Promise.reject(error);
            });
          };
          
          // Override authenticate to use existing token
          const originalAuthenticate = backend.authenticate;
          backend.authenticate = function() {
            const token = localStorage.getItem('netlify-cms-auth-token');
            if (token) {
              return backend.restoreUser();
            }
            return originalAuthenticate ? originalAuthenticate.call(this) : Promise.reject('No token');
          };
          
          // Call restoreUser to authenticate immediately
          if (window._decapCMSUserCache) {
            backend.restoreUser().then(function(user) {
              console.log('Authenticated:', user);
              
              // Ensure CMS renders by updating Redux store
              setTimeout(function() {
                try {
                  const CMS = window.CMS || window.netlifyCMS;
                  if (CMS && CMS.getApp) {
                    const app = CMS.getApp();
                    if (app && app.store) {
                      app.store.dispatch({ 
                        type: 'AUTHENTICATE_USER_SUCCESS', 
                        user: user,
                        token: user.token 
                      });
                      app.store.dispatch({ 
                        type: 'USER_RECEIVED', 
                        user: user 
                      });
                    }
                  }
                } catch (e) {
                  console.log('Could not update store:', e);
                }
              }, 200);
            });
          }
        } catch (e) {
          console.log('Auth setup error:', e);
          setTimeout(setupAuth, 100);
        }
      }
    })();
  </script>
</body>
</html>

