<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link href="/orthodox-website/admin/config.yml" type="text/yaml" rel="cms-config-url" />
</head>
<body>
  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('access_token');
      if (token) {
        // Save the token to LocalStorage (Shared with the main window)
        localStorage.setItem('netlify-cms-auth-token', token);
        
        // Visual confirmation
        document.body.innerHTML = `
          <div style="display:flex;height:100vh;align-items:center;justify-content:center;font-family:sans-serif;flex-direction:column;text-align:center;">
            <h1>Login successful!</h1>
            <p>You can close this window if it doesn't close automatically.</p>
          </div>
        `;
        
        // Attempt to notify opener directly (Backup plan)
        try {
          if (window.opener) {
            window.opener.postMessage("cms-auth-success", "*");
          }
        } catch(e) { /* ignore cross-origin issues */ }

        // Close self
        setTimeout(() => window.close(), 1000);
        
        // Stop execution to ensure no CMS scripts load in the popup
        throw new Error('[Decap Popup] Token saved, stopping execution.');
      }
    })();
  </script>

  <script>
    window.CMS_MANUAL_INIT = true;
    const PROXY_URL = 'https://decap-oauth-proxy.danieligazit.workers.dev';

    async function fetchUser(token) {
      console.log('[Decap Trap] fetching user data...');
      const response = await fetch(`${PROXY_URL}/user`, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!response.ok) throw new Error('Failed to fetch user');
      const userData = await response.json();
      return {
        token: token,
        name: userData.name || userData.login,
        login: userData.login,
        avatar_url: userData.avatar_url,
        email: userData.email
      };
    }

    let _cms;
    Object.defineProperty(window, 'CMS', {
      get: function() { return _cms; },
      set: function(cmsInstance) {
        _cms = cmsInstance;
        
        if (_cms && _cms.registerBackend) {
          const originalRegister = _cms.registerBackend;
          
          _cms.registerBackend = function(name, BackendClass, options) {
            if (name === 'github') {
              console.log('[Decap Trap] Intercepted GitHub registration.');
              
              class CustomGitHubBackend extends BackendClass {
                
                // AUTHENTICATE OVERRIDE
                authenticate(credentials) {
                  // 1. Check for existing token
                  const existingToken = localStorage.getItem('netlify-cms-auth-token');
                  if (existingToken) return this.restoreUser();

                  // 2. Trigger standard Popup
                  // We catch errors here because we expect the popup flow to be "broken" 
                  // by our custom closer script, and that's okay.
                  super.authenticate(credentials).catch(err => {
                    console.log('[Decap Trap] Native auth promise ended (expected).');
                  });

                  // 3. Listen for the token (The important part)
                  return new Promise((resolve, reject) => {
                    console.log('[Decap Trap] Waiting for token...');
                    
                    // Strategy A: Poll LocalStorage (Backup)
                    const poll = setInterval(() => {
                      const token = localStorage.getItem('netlify-cms-auth-token');
                      if (token) {
                        console.log('[Decap Trap] Token found via Polling!');
                        finish(token);
                      }
                    }, 500);

                    // Strategy B: Listen for Storage Events (Primary & Faster)
                    const onStorage = (e) => {
                      if (e.key === 'netlify-cms-auth-token' && e.newValue) {
                         console.log('[Decap Trap] Token found via Event!');
                         finish(e.newValue);
                      }
                    };
                    
                    // Strategy C: Listen for direct PostMessage (Fastest)
                    const onMessage = (e) => {
                      if (e.data === "cms-auth-success") {
                        console.log('[Decap Trap] Token found via PostMessage!');
                        const token = localStorage.getItem('netlify-cms-auth-token');
                        if (token) finish(token);
                      }
                    };

                    window.addEventListener('storage', onStorage);
                    window.addEventListener('message', onMessage);

                    // Cleanup and Log In
                    function finish(token) {
                      clearInterval(poll);
                      window.removeEventListener('storage', onStorage);
                      window.removeEventListener('message', onMessage);
                      
                      fetchUser(token)
                        .then(user => {
                          console.log('[Decap Trap] Login complete.');
                          resolve(user);
                        })
                        .catch(err => {
                          console.error('[Decap Trap] User fetch failed:', err);
                          reject(err);
                        });
                    }
                  });
                }

                async restoreUser() {
                  const token = localStorage.getItem('netlify-cms-auth-token');
                  if (!token) return Promise.reject();
                  try {
                    return await fetchUser(token);
                  } catch (e) {
                    localStorage.removeItem('netlify-cms-auth-token');
                    return Promise.reject();
                  }
                }
              }

              originalRegister.call(this, name, CustomGitHubBackend, options);
            } else {
              originalRegister.call(this, name, BackendClass, options);
            }
          };
        }
      }
    });
  </script>

  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>

  <script>
    const interval = setInterval(() => {
      if (window.CMS) {
        clearInterval(interval);
        console.log('[Decap Debug] Starting CMS...');
        window.CMS.init();
      }
    }, 100);
  </script>
</body>
</html>