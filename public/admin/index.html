<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link href="/orthodox-website/admin/config.yml" type="text/yaml" rel="cms-config-url" />
</head>
<body>
  <script>
    // ---------------------------------------------------------
    // 1. POPUP HANDLING (The Fix for the "Infinite Loop")
    // ---------------------------------------------------------
    // If we are in the popup (have a token in URL), save it and CLOSE.
    // We do this immediately before loading any CMS scripts.
    (function() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('access_token');
      
      if (token) {
        console.log('[Decap Popup] Token detected:', token);
        localStorage.setItem('netlify-cms-auth-token', token);
        
        document.body.innerHTML = '<div style="display:flex;height:100vh;justify-content:center;align-items:center;font-family:sans-serif;"><h1>Login successful. Closing...</h1></div>';
        
        // Notify the opener (Main Window) if possible
        if (window.opener) {
            window.opener.postMessage("authorization:github:success:" + token, "*");
        }
        
        // Close this window
        setTimeout(() => {
            window.close();
        }, 500);
        
        // STOP EXECUTION HERE. Do not load the CMS.
        throw new Error('[Decap Popup] Token saved, stopping execution to prevent CMS load.');
      }
    })();
  </script>

  <script>window.CMS_MANUAL_INIT = true;</script>
  
  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>

  <script>
    const PROXY_URL = 'https://decap-oauth-proxy.danieligazit.workers.dev';

    // Helper: Validates the token against your worker
    async function fetchUser(token) {
      const response = await fetch(`${PROXY_URL}/user`, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!response.ok) throw new Error('Failed to fetch user');
      const userData = await response.json();
      return {
        token: token,
        name: userData.name || userData.login,
        login: userData.login,
        avatar_url: userData.avatar_url,
        email: userData.email
      };
    }

    // ---------------------------------------------------------
    // 3. OVERWRITE BACKEND LOGIC
    // ---------------------------------------------------------
    const registerCustomBackend = () => {
      console.log('[Decap Debug] Starting backend registration...');
      
      const CMS = window.CMS;
      
      // We explicitly GET the class to extend it
      const GitHubBackend = CMS.getBackend('github');
      
      if (!GitHubBackend) {
         console.error('[Decap Debug] Could not find default "github" backend to extend.');
         return;
      }

      // Create our Custom Class
      class CustomGitHubBackend extends GitHubBackend {
        constructor(config, ...args) {
          super(config, ...args);
        }

        // 1. Authenticate (The "Login" button click)
        authenticate(credentials) {
          console.log('[Decap Debug] Authenticate clicked');
          
          // Check if we have a valid token already
          const token = localStorage.getItem('netlify-cms-auth-token');
          if (token) {
            return this.restoreUser();
          }

          // If no token, we trigger the standard popup flow.
          // BUT, we start a poller to watch for the token appearing in localStorage
          // because our Popup script (at the top of this file) puts it there.
          const authPromise = super.authenticate(credentials);
          
          return new Promise((resolve, reject) => {
            // Check LocalStorage every 200ms
            const poll = setInterval(() => {
              const localToken = localStorage.getItem('netlify-cms-auth-token');
              if (localToken) {
                clearInterval(poll);
                console.log('[Decap Debug] Token found via polling! Logging in...');
                // Token found, verify it and log in
                fetchUser(localToken).then(resolve).catch(reject);
              }
            }, 200);

            // Also allow the standard promise to resolve (in case standard postMessage works)
            authPromise.then(resolve).catch((err) => {
               // Ignore errors if we are polling, or handle them
               console.log('[Decap Debug] Standard auth flow finished:', err);
            });
            
            // Timeout after 2 minutes
            setTimeout(() => clearInterval(poll), 120000);
          });
        }

        // 2. Restore User (Page Refresh)
        async restoreUser() {
          const token = localStorage.getItem('netlify-cms-auth-token');
          if (!token) return Promise.reject();
          
          console.log('[Decap Debug] Restoring user from LocalStorage...');
          try {
            return await fetchUser(token);
          } catch (e) {
            localStorage.removeItem('netlify-cms-auth-token');
            return Promise.reject();
          }
        }
      }

      // EXPLICITLY OVERWRITE 'github'
      // This forces Decap to use our class, even if it registered the default one internally
      CMS.registerBackend('github', CustomGitHubBackend);
      console.log('[Decap Debug] "github" backend overwritten successfully.');
    };

    // 4. BOOTSTRAP
    const interval = setInterval(() => {
      if (window.CMS) {
        clearInterval(interval);
        
        // 1. Register logic
        registerCustomBackend();
        
        // 2. Start CMS
        console.log('[Decap Debug] CMS.init()');
        window.CMS.init();
      }
    }, 50);
  </script>
</body>
</html>