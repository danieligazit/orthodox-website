<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Point Decap CMS to the config file -->
  <link href="/orthodox-website/admin/config.yml" type="text/yaml" rel="cms-config-url" />
</head>
<body>
  <!-- Handle OAuth callback token -->
  <script>
    // Read token from URL and make it available to Decap CMS
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get('access_token');
    
    if (accessToken) {
      // Store token for Decap CMS
      localStorage.setItem('netlify-cms-auth-token', accessToken);
      
      // Clean up URL - remove query params but keep hash if present
      const cleanUrl = window.location.pathname + (window.location.hash || '');
      window.history.replaceState({}, document.title, cleanUrl);
      
      // Force page reload to ensure Decap CMS picks up the token
      // Note: reload() stops execution automatically, no return needed
      window.location.reload();
    }
  </script>
  
  <script>
    // Intercept ALL network requests BEFORE Decap CMS loads to ensure token is always sent
    // This must run before Decap CMS initializes
    (function() {
      // Store original fetch immediately
      const originalFetch = window.fetch;
      
      // Override fetch to add Authorization header for proxy requests
      window.fetch = function(url, options = {}) {
        // Always check for token (in case it was just stored)
        const token = localStorage.getItem('netlify-cms-auth-token');
        
        // If this is a request to our OAuth proxy, add the token
        if (token && typeof url === 'string' && url.includes('decap-oauth-proxy')) {
          options = options || {};
          
          // Handle both Headers object and plain object
          if (options.headers instanceof Headers) {
            if (!options.headers.has('Authorization')) {
              options.headers.set('Authorization', `token ${token}`);
            }
          } else {
            options.headers = options.headers || {};
            // Check both cases
            if (!options.headers['Authorization'] && !options.headers['authorization']) {
              options.headers['Authorization'] = `token ${token}`;
            }
          }
        }
        
        return originalFetch.call(this, url, options);
      };
      
      // Also intercept XMLHttpRequest (some libraries use this instead of fetch)
      const originalXHROpen = XMLHttpRequest.prototype.open;
      const originalXHRSend = XMLHttpRequest.prototype.send;
      const originalXHRSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
      
      XMLHttpRequest.prototype.open = function(method, url, ...args) {
        this._url = url;
        return originalXHROpen.apply(this, [method, url, ...args]);
      };
      
      XMLHttpRequest.prototype.setRequestHeader = function(name, value) {
        // Store headers to check later
        if (!this._headers) {
          this._headers = {};
        }
        this._headers[name.toLowerCase()] = value;
        return originalXHRSetRequestHeader.apply(this, arguments);
      };
      
      XMLHttpRequest.prototype.send = function(...args) {
        const token = localStorage.getItem('netlify-cms-auth-token');
        if (token && this._url && this._url.includes('decap-oauth-proxy')) {
          // Check if Authorization header is already set
          if (!this._headers || !this._headers['authorization']) {
            originalXHRSetRequestHeader.call(this, 'Authorization', `token ${token}`);
          }
        }
        return originalXHRSend.apply(this, args);
      };
    })();
  </script>
  
  <script>
    // Intercept backend registration BEFORE Decap CMS loads
    // This ensures our override is in place before Decap CMS initializes
    (function() {
      const token = localStorage.getItem('netlify-cms-auth-token');
      
      if (!token) {
        return;
      }
      
      // Store original registerBackend if it exists
      const originalRegisterBackend = window.CMS && window.CMS.registerBackend;
      
      // Override registerBackend to intercept GitHub backend registration
      if (window.CMS) {
        const originalRegister = window.CMS.registerBackend;
        window.CMS.registerBackend = function(name, BackendClass) {
          const result = originalRegister.apply(this, arguments);
          
          // If this is the GitHub backend, wrap its methods immediately
          if (name === 'github') {
            setTimeout(function() {
              try {
                const backend = window.CMS.getBackend('github');
                if (backend && !backend._authOverrideSet) {
                  setupBackendAuth(backend);
                }
              } catch (e) {
                console.log('Error setting up backend auth:', e);
              }
            }, 0);
          }
          
          return result;
        };
      }
    })();
  </script>
  
  <!-- Include Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>
  
  <script>
    // Function to set up backend authentication
    function setupBackendAuth(backend) {
      if (backend._authOverrideSet) {
        return;
      }
      
      backend._authOverrideSet = true;
      const token = localStorage.getItem('netlify-cms-auth-token');
      
      if (!token) {
        return;
      }
      
      // Store original methods
      const originalRestoreUser = backend.restoreUser;
      const originalAuthenticate = backend.authenticate;
      
      // Pre-fetch user data and set currentUser synchronously if possible
      // This helps Decap CMS recognize authentication immediately
      const proxyUrl = 'https://decap-oauth-proxy.danieligazit.workers.dev';
      fetch(`${proxyUrl}/user`, {
        headers: {
          'Authorization': `token ${token}`
        }
      })
      .then(response => {
        if (response.ok) {
          return response.json().then(userData => {
            const user = {
              token: token,
              name: userData.login || userData.name,
              login: userData.login,
              avatar_url: userData.avatar_url,
              email: userData.email
            };
            
            // Set currentUser immediately so Decap CMS sees authenticated state
            backend.currentUser = user;
            if (backend.user !== undefined) {
              backend.user = user;
            }
            
            console.log('Pre-authenticated user:', user);
          });
        }
      })
      .catch(err => {
        console.log('Pre-auth check failed, will retry:', err);
      });
      
      // Override restoreUser
      backend.restoreUser = function() {
        const storedToken = localStorage.getItem('netlify-cms-auth-token');
        if (!storedToken) {
          return originalRestoreUser ? originalRestoreUser.call(this) : Promise.reject('No token');
        }
        
        const proxyUrl = 'https://decap-oauth-proxy.danieligazit.workers.dev';
        return fetch(`${proxyUrl}/user`, {
          headers: {
            'Authorization': `token ${storedToken}`
          }
        })
        .then(response => {
          if (response.ok) {
            return response.json().then(userData => {
              const user = {
                token: storedToken,
                name: userData.login || userData.name,
                login: userData.login,
                avatar_url: userData.avatar_url,
                email: userData.email
              };
              
              // Set currentUser on backend so Decap CMS recognizes authentication
              backend.currentUser = user;
              
              // Also try to set it on the backend's user property if it exists
              if (backend.user !== undefined) {
                backend.user = user;
              }
              
              return user;
            });
          } else {
            localStorage.removeItem('netlify-cms-auth-token');
            backend.currentUser = null;
            if (backend.user !== undefined) {
              backend.user = null;
            }
            throw new Error('Token invalid');
          }
        })
        .catch(error => {
          console.error('Token verification failed:', error);
          backend.currentUser = null;
          if (backend.user !== undefined) {
            backend.user = null;
          }
          return originalRestoreUser ? originalRestoreUser.call(this) : Promise.reject(error);
        });
      };
      
      // Override authenticate
      backend.authenticate = function() {
        const storedToken = localStorage.getItem('netlify-cms-auth-token');
        if (storedToken) {
          return backend.restoreUser();
        }
        return originalAuthenticate ? originalAuthenticate.call(this) : Promise.reject('No token');
      };
    }
    
    // Configure Decap CMS authentication after it loads
    (function() {
      const token = localStorage.getItem('netlify-cms-auth-token');
      
      if (!token) {
        return;
      }
      
      function setupAuth() {
        const CMS = window.CMS || window.netlifyCMS;
        if (!CMS) return false;
        
        try {
          const backend = CMS.getBackend('github');
          if (!backend) {
            return false;
          }
          
          setupBackendAuth(backend);
          
          // Try to restore user - Decap CMS should call this automatically, but we'll call it too
          backend.restoreUser()
            .then(function(user) {
              console.log('User authenticated:', user);
              
              // Force Decap CMS to recognize the authenticated state
              // Try multiple ways to trigger UI update
              setTimeout(function() {
                try {
                  const CMS = window.CMS || window.netlifyCMS;
                  
                  // Try to get the app and trigger a state update
                  if (CMS.getApp) {
                    const app = CMS.getApp();
                    if (app && app.store) {
                      // Dispatch authentication success
                      app.store.dispatch({ type: 'AUTHENTICATION_SUCCESS', user: user });
                    }
                  }
                  
                  // Also try to trigger a re-render by accessing the backend again
                  const backend = CMS.getBackend('github');
                  if (backend && backend.currentUser) {
                    // Force a check by calling a method that triggers state update
                    if (typeof backend.status === 'function') {
                      backend.status();
                    }
                  }
                } catch (e) {
                  console.log('Could not force UI update:', e);
                }
              }, 500);
            })
            .catch(function(error) {
              console.log('Authentication check failed:', error);
            });
          
          return true;
        } catch (error) {
          console.error('Error configuring Decap CMS authentication:', error);
          return false;
        }
      }
      
      // Try immediately
      if (!setupAuth()) {
        let checkCount = 0;
        const maxChecks = 200;
        
        const checkInterval = setInterval(function() {
          checkCount++;
          if (setupAuth() || checkCount >= maxChecks) {
            clearInterval(checkInterval);
          }
        }, 50);
      }
      
      window.addEventListener('DOMContentLoaded', setupAuth);
      setTimeout(setupAuth, 1000);
    })();
  </script>
</body>
</html>